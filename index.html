<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>TerraTech Block Info</title>

    <!-- DataTables CSS (local) -->
    <!-- <link href="node_modules/datatables.net-dt/css/dataTables.dataTables.min.css" rel="stylesheet"> -->

    <!-- DataTables Buttons CSS (local) -->
    <!-- <link href="node_modules/datatables.net-buttons-dt/css/buttons.dataTables.min.css" rel="stylesheet"> -->

    <!-- Bootstrap CSS (local) -->
    <!-- <link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet"> -->

    <!-- DataTables CSS (CDN) -->
    <link href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" rel="stylesheet">

    <!-- DataTables Buttons CSS (CDN) -->
    <link href="https://cdn.datatables.net/buttons/2.1.1/css/buttons.dataTables.min.css" rel="stylesheet">

    <!-- Bootstrap CSS (CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            font-family: "Microsoft JhengHei", sans-serif;
        }

        #content-wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f8f9fc;
        }

        #content {
            flex: 1;
        }

        .left-col {
            float: right;
            width: 30%;
            text-align: right;
        }

        .center-col {
            float: right;
            width: 30%;
        }

        .right-col {
            float: left;
            width: 40%;
            text-align: left;
        }

        .custom-color {
            color: #2c7dc0;
        }

        .btn-outline {
            --bs-btn-color: #2c7dc0;
            --bs-btn-border-color: #2c7dc0;
            --bs-btn-hover-color: #fff;
            --bs-btn-hover-bg: #2c7dc0;
            --bs-btn-hover-border-color: #2c7dc0;
            --bs-btn-focus-shadow-rgb: 13, 110, 253;
            --bs-btn-active-color: #fff;
            --bs-btn-active-bg: #2c7dc0;
            --bs-btn-active-border-color: #2c7dc0;
            --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
            --bs-btn-disabled-color: #2c7dc0;
            --bs-btn-disabled-bg: #2c7dc0;
            --bs-btn-disabled-border-color: #2c7dc0;
            --bs-gradient: none;
            background-color: #b4daf8;
        }
    </style>
</head>

<body id="page-top" style="height: 100%;">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">

                <!-- Begin Page Content -->
                <div class="container-fluid mt-4">

                    <!-- Page Heading -->
                    <div class="d-sm-flex align-items-center mb-4">
                        <h1 class="h1 mb-0 custom-color"><B>TerraTech Block Info</B></h1>
                    </div>

                    <div class="row align-items-center mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body row">
                                    <div class="col-12 mb-1">
                                        <div id="categoryFilterAll" class="btn-group me-2" role="group">
                                        </div>
                                        <div id="categoryFilter" class="btn-group" role="group">
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div id="corpFilterAll" class="btn-group me-2" role="group">
                                        </div>
                                        <div id="corpFilter" class="btn-group" role="group">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row align-items-center mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered" id="blockTable" width="100%"
                                            cellspacing="0">
                                            <thead>
                                                <tr>
                                                    <th></th>
                                                    <th>名称</th>
                                                    <th>资源名称</th>
                                                    <th>质量</th>
                                                    <th>解锁等级</th>
                                                    <th>价格</th>
                                                    <th>稀有度</th>
                                                    <th>血量</th>
                                                    <th>脆弱度</th>
                                                    <th>损毁爆炸</th>
                                                    <th>损伤类型</th>
                                                    <th>占格数</th>
                                                    <th>连接点数</th>
                                                    <th>合成配方</th>
                                                    <th>油箱模块数据</th>
                                                    <th>电池模块数据</th>
                                                    <th>屏障发生器模块数据</th>
                                                    <th>悬停模块数据</th>
                                                    <th>火力模块数据</th>
                                                    <th>冲击模块数据</th>
                                                    <th>武器模块数据</th>
                                                    <th>轮模块数据</th>
                                                    <th>推进器模块数据</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- DataTables 將填充資料進這裡 -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- /.container-fluid -->

            </div>
            <!-- End of Main Content -->

            <!-- Footer -->
            <footer class="footer">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>TWiLai暮光 2024</span>
                    </div>
                </div>
            </footer>
            <!-- End of Footer -->

        </div>
        <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <!-- Core plugin JavaScript (local) -->
    <!-- <script src="node_modules/jquery/dist/jquery.min.js"></script> -->

    <!-- Bootstrap core JavaScript (local) -->
    <!-- <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script> -->

    <!-- DataTables JS (local) -->
    <!-- <script src="node_modules/datatables.net/js/dataTables.min.js"></script> -->

    <!-- DataTables Buttons JS (local) -->
    <!-- <script src="node_modules/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="node_modules/jszip/dist/jszip.min.js"></script>
    <script src="node_modules/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="node_modules/datatables.net-buttons-dt/js/buttons.dataTables.min.js"></script> -->

    <!-- Core plugin JavaScript (CDN) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Bootstrap core JavaScript (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables JS (CDN) -->
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>

    <!-- DataTables Buttons JS (CDN) -->
    <script src="https://cdn.datatables.net/buttons/2.1.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.1.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.1.1/js/buttons.print.min.js"></script>

    <script>
        var dataTable;

        var originData;

        var filterData;

        var corps = [
            {
                "corp_int": 0,
                "corp": "全部",
                "corp_Pic": "ICONS_FILTERS_ALL_CORPS"
            },
            {
                "corp_int": 1,
                "corp": "GSO",
                "corp_Pic": "GSO_LOGO_STYLE_FLAT_DS"
            },
            {
                "corp_int": 2,
                "corp": "GC",
                "corp_Pic": "GEOCORP_LOGO_STYLE_FLAT_DS"
            },
            {
                "corp_int": 4,
                "corp": "VEN",
                "corp_Pic": "VENTURE_LOGO_STYLE_FLAT_DS"
            },
            {
                "corp_int": 5,
                "corp": "HE",
                "corp_Pic": "HAWKEYE_LOGO_STYLE_FLAT_DS"
            },
            {
                "corp_int": 7,
                "corp": "BF",
                "corp_Pic": "BF_LOGO_STYLE_FLAT_DS"
            },
            {
                "corp_int": 8,
                "corp": "SJ",
                "corp_Pic": "SJ_LOGO_STYLE_FLAT_DS"
            },
            {
                "corp_int": 3,
                "corp": "RR",
                "corp_Pic": "RR_REVERSE_LOGO_STYLE_FLAT_DS"
            },
            {
                "corp_int": 6,
                "corp": "SP",
                "corp_Pic": "SPEHatRed_111"
            }
        ]

        var categorys = [
            {
                "category_int": 0,
                "category": "全部",
                "category_Pic": "ICON_BLOCK_TYPE_ALL"
            },
            {
                "category_int": 2,
                "category": "一般",
                "category_Pic": "ICON_BLOCK_TYPE_STANDARD"
            },
            {
                "category_int": 1,
                "category": "控制艙",
                "category_Pic": "ICON_BLOCK_TYPE_CONTROL"
            },
            {
                "category_int": 3,
                "category": "車輪",
                "category_Pic": "ICON_BLOCK_TYPE_WHEELS"
            },
            {
                "category_int": 4,
                "category": "武器",
                "category_Pic": "ICON_BLOCK_TYPE_WEAPONS"
            },
            {
                "category_int": 5,
                "category": "裝飾和其他",
                "category_Pic": "ICON_BLOCK_TYPE_ACCESSORY"
            },
            {
                "category_int": 6,
                "category": "電力",
                "category_Pic": "ICON_BLOCK_TYPE_FUEL"
            },
            {
                "category_int": 7,
                "category": "工業",
                "category_Pic": "ICON_BLOCK_TYPE_BASEBLOCKS"
            },
            {
                "category_int": 8,
                "category": "航空",
                "category_Pic": "ICON_BLOCK_TYPE_FLIGHT"
            }
        ]

        function fetchData(url, successCallback, errorCallback) {
            // 使用 fetch 從指定 URL 中取得資料
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('網路回應異常');
                    }
                    return response.json();
                })
                .then(data => {
                    // 如果成功取得資料，則呼叫 successCallback 函式，並傳遞資料作為參數
                    successCallback(data);
                })
                .catch(error => {
                    // 如果發生錯誤，則呼叫 errorCallback 函式，並傳遞錯誤訊息作為參數
                    errorCallback(error);
                });
        }

        $(document).ready(function () {
            fetchData(
                'data/BlockInfoDump.json',
                function (data) {
                    // 成功取得資料時的回調函式
                    // 在這裡可以對取得的資料進行操作，例如將資料指派給變數或呼叫其他函式
                    originData = data;
                    filterData = originData;

                    // 繪製 DataTable
                    drawDataTable(filterData.data_blocks);

                    // 獲取包含按鈕組的父元素
                    var categoryFilterAll = document.getElementById('categoryFilterAll');
                    var categoryFilter = document.getElementById('categoryFilter');
                    var corpFilterAll = document.getElementById('corpFilterAll');
                    var corpFilter = document.getElementById('corpFilter');

                    // 繪製按鈕組
                    drawFilterButtons(categoryFilterAll, categoryFilter, categorys, 'category');
                    drawFilterButtons(corpFilterAll, corpFilter, corps, 'corp');

                    // 設定"全部"按鈕
                    setAllButton('btncheck_category_0', 'category');
                    setAllButton('btncheck_corp_0', 'corp');

                    // 監聽 categoryFilter 和 corpFilter 內所有 checkbox 的改變事件
                    $('input[type="checkbox"]').on('change', function () {
                        // 更新 DataTable
                        updateDataTable();
                    });
                },
                function (error) {
                    // 取得資料失敗時的回調函式
                    console.error('取得資料時發生問題:', error);
                }
            );

            // filterData = originData;
            // // 繪製 DataTable
            // drawDataTable(filterData.data_blocks);

            // // 獲取包含按鈕組的父元素
            // var categoryFilterAll = document.getElementById('categoryFilterAll');
            // var categoryFilter = document.getElementById('categoryFilter');
            // var corpFilterAll = document.getElementById('corpFilterAll');
            // var corpFilter = document.getElementById('corpFilter');

            // // 繪製按鈕組
            // drawFilterButtons(categoryFilterAll, categoryFilter, categorys, 'category');
            // drawFilterButtons(corpFilterAll, corpFilter, corps, 'corp');

            // // 設定"全部"按鈕
            // setAllButton('btncheck_category_0', 'category');
            // setAllButton('btncheck_corp_0', 'corp');

            // // 監聽 categoryFilter 和 corpFilter 內所有 checkbox 的改變事件
            // $('input[type="checkbox"]').on('change', function () {
            //     // 更新 DataTable
            //     updateDataTable();
            // });
        });

        // 封裝渲染 JSON 的函數
        function JSONrender(data) {
            if (!data) return ''; // 如果為空，返回空字串

            // 解析並格式化 JSON
            var result = "";
            for (var key in data) {
                if (data.hasOwnProperty(key)) {
                    var value = data[key];

                    if (typeof value === 'object') {
                        // 將值轉換為格式化的 JSON 字符串
                        var formattedValue = JSON.stringify(value, null, 4);
                        // 將格式化的 JSON 字符串中的換行符替換為<br>標籤
                        formattedValue = formattedValue.replace(/\n/g, "<br>");
                        // 將格式化的 JSON 字符串添加到結果中
                        result += '"' + key + '"' + ": " + formattedValue + "<br>";
                    } else {
                        result += '"' + key + '"' + ": " + value + ",<br>";
                    }
                }
            }
            return result;
        }



        // 封裝生成圖片的函數
        function blockPic(data, type, row) {
            if (type === 'display') {
                var picName = row.enum;
                //特例
                if (row.enum == "VEN_Radar_Minimap_211") {
                    picName = "VEN_Radar_MiniMap_211";
                }
                var imgSrc = 'assets/Texture2D/' + picName + '.png';
                return '<img src="' + imgSrc + '" alt="' + row.enum + '" style="width: 50px; height: auto;">';
                // // 發送 XMLHttpRequest
                // var http = new XMLHttpRequest();
                // http.open('HEAD', imgSrc, false);
                // http.send();

                // // 檢查圖片是否存在
                // if (http.status !== 404) {
                //     // 如果圖片存在，則在欄位中生成圖片
                //     return '<img src="' + imgSrc + '" alt="' + row.resource_name + '" style="width: 50px; height: auto;">';
                // } else {
                //     // 如果圖片不存在，則返回一個提示
                //     return '圖片不存在';
                // }
            }
            return data;
        }

        function JSONrecipe(data) {
            if (!data || !Array.isArray(data)) return ''; // 如果数据为空或不是数组，返回空字符串

            var result = '';
            data.forEach(function (ingredient) {
                result += ingredient.name + ' x ' + ingredient.count + '<br>';
            });
            return result;
        }



        // 封裝繪製 DataTable 的函數
        function drawDataTable(data) {
            dataTable = $('#blockTable').DataTable({
                "data": data,
                "columns": [
                    { "data": "enum", "render": blockPic },
                    { "data": "block" },
                    { "data": "resource_name" },
                    { "data": "mass" },
                    { "data": "grade" },
                    { "data": "price" },
                    { "data": "rarity" },
                    { "data": "health" },
                    { "data": "fragility" },
                    { "data": "DeathExplosion", "render": JSONrender },
                    { "data": "damageable_type" },
                    { "data": "cell_count" },
                    { "data": "ap_count" },
                    { "data": "recipe", "render": JSONrecipe },
                    { "data": "ModuleFuelTank", "render": JSONrender },
                    { "data": "ModuleEnergyStore", "render": JSONrender },
                    { "data": "ModuleShieldGenerator", "render": JSONrender },
                    { "data": "ModuleHover", "render": JSONrender },
                    { "data": "FireData", "render": JSONrender },
                    { "data": "ModuleHammer", "render": JSONrender },
                    { "data": "ModuleWeapon", "render": JSONrender },
                    { "data": "ModuleWheels", "render": JSONrender },
                    { "data": "ModuleBooster", "render": JSONrender }
                ],
                "lengthMenu": [[10, 15, 20, 25, 30, 50, 100, -1], [10, 15, 20, 25, 30, 50, 100, "All"]],
                "pageLength": -1,
                "responsive": true,
                "dom": '<"top"<"left-col"B><"center-col"l><"right-col"f>>rtip',
                "buttons": [
                    {
                        extend: 'excelHtml5',
                        text: '將目前篩選的資料匯出Excel'
                    }
                ]
            });

            $('#blockTable_length select').change(function () {
                var length = $(this).val();
                if (length == -1) {
                    dataTable.page.len(-1).draw();
                }
            });
        }

        // 更新 DataTable 的函數
        function updateDataTable() {
            // 構建需要篩選的條件
            var categoryFilterConditions = [];
            var corpFilterConditions = [];

            // 遍歷 categoryFilter 內的 checkbox
            $('#categoryFilter input[type="checkbox"]').each(function () {
                if (this.checked) {
                    // 如果 checkbox 被勾選，將 category_int 加入篩選條件中
                    categoryFilterConditions.push($(this).attr('id').replace('btncheck_category_', ''));
                }
            });

            // 遍歷 corpFilter 內的 checkbox
            $('#corpFilter input[type="checkbox"]').each(function () {
                if (this.checked) {
                    // 如果 checkbox 被勾選，將 corp_int 加入篩選條件中
                    corpFilterConditions.push($(this).attr('id').replace('btncheck_corp_', ''));
                }
            });

            // 更新 datatable 的資料
            var filteredData = originData.data_blocks.filter(function (item) {
                // 檢查是否符合 categoryFilter 的篩選條件
                var passCategoryFilter = categoryFilterConditions.length === 0 || categoryFilterConditions.includes(item.category_int.toString());

                // 檢查是否符合 corpFilter 的篩選條件
                var passCorpFilter = corpFilterConditions.length === 0 || corpFilterConditions.includes(item.corp_int.toString());

                return passCategoryFilter && passCorpFilter;
            });

            dataTable.clear().rows.add(filteredData).draw(); // 清空並重新繪製 DataTable
        }
        // 封裝繪製按鈕組的函數
        function drawFilterButtons(parentAll, parent, items, type) {
            items.forEach(function (item) {
                // 創建 input 元素
                var checkbox = document.createElement('input');
                checkbox.className = 'btn-check btn-sm';
                checkbox.id = 'btncheck_' + type + '_' + item[type + '_int'];
                checkbox.autocomplete = 'off';

                // 創建 label 元素
                var label = document.createElement('label');
                label.className = 'btn btn-outline';
                label.htmlFor = 'btncheck_' + type + '_' + item[type + '_int'];

                // 創建圖像元素
                var img = document.createElement('img');
                img.src = "assets/Texture2D/" + item[type + '_Pic'] + ".png";
                img.style.width = '30px';
                img.style.height = '30px';

                // 創建 span 元素，顯示名稱
                var span = document.createElement('span');
                span.textContent = item[type];

                // 將圖片、span 元素添加到 label 內
                label.appendChild(img);
                label.appendChild(span);

                // 將 label 元素添加到父元素中
                if (item[type + '_int'] == 0) {
                    checkbox.type = 'button';
                    parentAll.appendChild(checkbox);
                    parentAll.appendChild(label);
                } else {
                    checkbox.type = 'checkbox';
                    parent.appendChild(checkbox);
                    parent.appendChild(label);
                }
            });
        }

        // 封裝設定"全部"按鈕的函數
        function setAllButton(btnId, parentFilterId) {
            var btnAll = document.getElementById(btnId);
            btnAll.addEventListener('click', function () {
                // 獲取所有按鈕
                var buttons = document.querySelectorAll('[id^="btncheck_' + parentFilterId + '_"]');

                // 遍歷所有按鈕
                buttons.forEach(function (button) {
                    // 取消勾選
                    if (button.id !== btnId) {
                        button.checked = false;
                    }
                });
                updateDataTable();
            });
        }

    </script>
</body>

</html>